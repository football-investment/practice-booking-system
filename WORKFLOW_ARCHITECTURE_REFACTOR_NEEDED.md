# Workflow Architecture Refactoring - Production Readiness Issues

**Date**: 2026-02-05
**Status**: üî¥ **BLOCKER** - System is not production-ready
**Root Cause**: Session state-based navigation without URL routing

---

## Problem Summary

The current E2E test for Group+Knockout tournaments **cannot complete the UI workflow** because:

1. **Final match exists in database** ‚úÖ
2. **Final match auto-generated by knockout progression service** ‚úÖ
3. **Final match NOT accessible via sandbox UI** ‚ùå

### Attempted Workarounds (All Failed)
- ‚ùå Direct URL navigation to Step 4
- ‚ùå Session state injection via JavaScript
- ‚ùå Page reload after semifinals (resets session state ‚Üí home screen)
- ‚ùå History-based tournament selection (Welcome screen persists instead of history list)

---

## Root Cause Analysis

### Issue 1: Session State-Only Navigation

```python
# streamlit_sandbox_v3_admin_aligned.py:1442
if st.session_state.screen == "home":
    render_home_screen()
elif st.session_state.screen == "history":
    render_history_screen()
elif st.session_state.screen == "instructor_workflow":
    render_instructor_workflow()
```

**Problem**: Navigation stored ONLY in `st.session_state`, not in URL.

**Consequences**:
- `page.reload()` resets session ‚Üí returns to home
- No deep-linking support (cannot share URLs to specific tournaments/steps)
- Browser back button doesn't work
- Cannot resume workflow after page refresh

### Issue 2: History Screen Rendering Bug

**Observed Behavior**:
```
Sandbox v3 | Screen: history    ‚Üê session_state says "history"
Tournament History              ‚Üê History screen title rendered
Welcome to the Tournament...    ‚Üê BUT Home screen content also rendered!
```

**Expected**: Only history screen content
**Actual**: Both screens render simultaneously OR home screen persists

**Theory**: Either:
1. Routing logic has a bug causing both screens to render
2. Streamlit caching issue causing stale content
3. `st.rerun()` not properly clearing previous screen

### Issue 3: Tournament Not Visible in History

Created tournament **DOES** have SANDBOX code:
```sql
SELECT code FROM semesters WHERE id = 1130;
-- Result: 'SANDBOX-sandbox-2026-02-05-13-27-38-9431'
```

Filter logic should work:
```python
# sandbox_helpers.py:319
if 'SANDBOX' in t.get('code', '') or 'sandbox' in t.get('code', '').lower()
```

But tournament **NOT visible** in history UI. Possible causes:
- `fetch_tournaments()` returns empty list
- `get_sandbox_tournaments()` filtering too aggressive
- UI rendering issue (tournaments fetch succeeds but render fails)

---

## Production Readiness Assessment

| Feature | Status | Impact |
|---------|--------|--------|
| Tournament creation (API) | ‚úÖ WORKING | None |
| Session generation | ‚úÖ WORKING | None |
| Result submission (API) | ‚úÖ WORKING | None |
| Knockout progression (backend) | ‚úÖ WORKING | None |
| Final match generation (DB) | ‚úÖ WORKING | None |
| **UI navigation (sandbox)** | ‚ùå **BROKEN** | **BLOCKER** |
| **History browser** | ‚ùå **BROKEN** | **BLOCKER** |
| **Workflow resumption** | ‚ùå **NOT SUPPORTED** | **BLOCKER** |
| **Deep linking** | ‚ùå **NOT SUPPORTED** | **CRITICAL** |

**Verdict**: System is **NOT production-ready** for instructor-led tournaments.

---

## Required Refactoring

### Phase 1: URL-Based Routing (High Priority)

**Goal**: Make navigation deterministic and resumable.

**Implementation**:
1. Use `st.query_params` for routing instead of session state
2. URL structure:
   ```
   http://localhost:8501/?screen=workflow&tournament_id=1130&step=4
   http://localhost:8501/?screen=history
   http://localhost:8501/?screen=home
   ```

3. On page load, read query params and restore session state:
   ```python
   def init_navigation():
       params = st.query_params
       if 'screen' in params:
           st.session_state.screen = params['screen']
       if 'tournament_id' in params:
           st.session_state.tournament_id = int(params['tournament_id'])
       if 'step' in params:
           st.session_state.workflow_step = int(params['step'])
   ```

4. Update query params on every navigation:
   ```python
   def navigate_to_workflow(tournament_id: int, step: int):
       st.session_state.tournament_id = tournament_id
       st.session_state.workflow_step = step
       st.session_state.screen = 'instructor_workflow'
       st.query_params.update({
           'screen': 'instructor_workflow',
           'tournament_id': str(tournament_id),
           'step': str(step)
       })
       st.rerun()
   ```

**Benefits**:
- ‚úÖ Page reload preserves navigation context
- ‚úÖ Deep linking works
- ‚úÖ Browser back/forward buttons work
- ‚úÖ Shareable URLs
- ‚úÖ E2E tests can navigate reliably

### Phase 2: Fix History Screen Rendering (High Priority)

**Investigation needed**:
1. Add debug logging to `render_history_screen()`:
   ```python
   def render_history_screen():
       print(f"üêõ render_history_screen called, screen={st.session_state.screen}")
       st.title("Tournament History", anchor=False)

       sandbox_tournaments = get_sandbox_tournaments()
       print(f"üêõ Found {len(sandbox_tournaments)} sandbox tournaments")

       if not sandbox_tournaments:
           st.info("No sandbox tournaments found")
           return
   ```

2. Verify routing exclusivity:
   ```python
   # Ensure only ONE screen renders
   if st.session_state.screen == "home":
       render_home_screen()
       return  # ‚Üê ADD explicit returns!
   elif st.session_state.screen == "history":
       render_history_screen()
       return
   ```

3. Test `fetch_tournaments()` in isolation to verify API call works

### Phase 3: Deterministic Workflow Steps (Medium Priority)

**Goal**: Each step should be independently accessible via URL.

**Implementation**:
1. Make each step stateless - load tournament data from DB on every render
2. Don't rely on session state for tournament data, only for navigation
3. Add validation at start of each step:
   ```python
   def render_step_enter_results():
       tournament_id = st.query_params.get('tournament_id')
       if not tournament_id:
           st.error("No tournament selected")
           return

       # Fetch fresh data from DB
       tournament = api_client.get(f"/tournaments/{tournament_id}")
       sessions = api_client.get(f"/sessions?semester_id={tournament_id}")

       # Render step...
   ```

### Phase 4: E2E Test Simplification (Low Priority)

Once navigation is fixed, the test becomes simple:
```python
# Navigate directly to Step 4 with tournament ID
page.goto(f"{SANDBOX_URL}/?screen=workflow&tournament_id={tournament_id}&step=4")
wait_for_streamlit(page)

# Verify final match is visible
assert page.locator(f"text=/Session.*{final_id}/i").count() > 0
```

No more:
- ‚ùå Clicking through history
- ‚ùå Clicking through workflow steps
- ‚ùå Session state manipulation
- ‚ùå Waiting for reruns

---

## Implementation Plan

### Week 1: URL Routing Foundation
- [ ] Add `init_navigation()` at app startup
- [ ] Update all navigation functions to write query params
- [ ] Test deep linking manually
- [ ] Update E2E test to use URL-based navigation

### Week 2: History Screen Fix
- [ ] Debug why tournaments don't appear
- [ ] Add explicit `return` statements in routing
- [ ] Test history screen in isolation
- [ ] Verify sandbox tournament filtering

### Week 3: Workflow Determinism
- [ ] Make each step load data from DB
- [ ] Remove session state dependencies for tournament data
- [ ] Add URL validation at step entry
- [ ] Test workflow resumption after page reload

### Week 4: E2E Validation
- [ ] Update all E2E tests to use URL-based navigation
- [ ] Verify final match visibility in sandbox UI
- [ ] Full regression testing
- [ ] Production deployment

---

## Temporary Workaround (Not Recommended)

If immediate testing is needed before refactoring:

**Option A**: Use API-only validation (skip UI)
```python
# Verify final match exists in DB
assert len(final_sessions) == 1

# Verify final match is submittable via API
response = requests.patch(f"{API_BASE}/api/v1/sessions/{final_id}/head-to-head-results", ...)
assert response.status_code == 200
```

**Option B**: Test only through main UI (not sandbox)
- Main UI might have better routing (needs investigation)

**Why these are NOT acceptable long-term**:
- API-only test doesn't validate instructor UX
- Main UI test doesn't cover sandbox workflow
- Instructor users WILL encounter these navigation issues in production

---

## Decision Required

**Question**: Should we:
1. **Proceed with refactoring** (recommended, 4 weeks)
2. **Ship with known navigation bugs** and document workarounds
3. **Disable sandbox workflow** until refactoring complete

**Recommendation**: **Option 1** - Refactor before production release.

**Rationale**:
- Navigation bugs will cause instructor frustration
- Workarounds don't scale to real usage
- Deep linking is essential for instructor workflow
- Better to fix architecture now than technical debt later

---

## Current Test Status

**Test**: `test_group_knockout_7_players_full_workflow`
**Result**: ‚ùå **FAILED** at Step 7 (UI navigation)
**Reason**: Cannot navigate to history screen and select tournament

**Backend**: ‚úÖ **100% FUNCTIONAL**
- Tournament created
- Sessions generated
- Group stage completed
- Semifinals completed
- **Final match exists in database**
- Final match has correct participants

**Frontend**: ‚ùå **BLOCKER**
- Cannot access tournament via history
- Cannot navigate to Step 4 to see final match
- Page reload resets workflow

---

## Next Steps

1. ‚è∏Ô∏è  **Pause E2E development** until navigation is fixed
2. üîß **Start Phase 1 refactoring** (URL-based routing)
3. üêõ **Debug history screen** rendering issue
4. ‚úÖ **Resume E2E testing** after navigation is stable

**Assigned to**: Frontend/Architecture Team
**Priority**: P0 - BLOCKER for production release
**Target**: Week of 2026-02-12

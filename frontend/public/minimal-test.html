<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iOS Firefox Minimal Test</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            line-height: 1.6;
        }
        .test-section {
            background: #f0f0f0;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .error {
            background: #ffebee;
            color: #c62828;
        }
        .success {
            background: #e8f5e8;
            color: #2e7d32;
        }
        button {
            padding: 10px 15px;
            margin: 5px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        .test-button {
            background: #2196f3;
            color: white;
        }
        .error-button {
            background: #f44336;
            color: white;
        }
    </style>
</head>
<body>
    <h1>üß™ iOS Firefox Minimal Compatibility Test</h1>
    
    <div class="test-section">
        <h3>Browser Detection:</h3>
        <div id="browser-info"></div>
    </div>
    
    <div class="test-section">
        <h3>JavaScript Compatibility Tests:</h3>
        <button onclick="testBasicJS()" class="test-button">Test Basic JS</button>
        <button onclick="testPromises()" class="test-button">Test Promises</button>
        <button onclick="testFetch()" class="test-button">Test Fetch API</button>
        <button onclick="testLocalStorage()" class="test-button">Test LocalStorage</button>
        <button onclick="simulateScriptError()" class="error-button">Simulate Script Error</button>
    </div>
    
    <div class="test-section">
        <h3>Results:</h3>
        <div id="results"></div>
    </div>
    
    <script>
        // Global error handler
        window.onerror = function(message, source, lineno, colno, error) {
            console.error('üö® GLOBAL ERROR:', {
                message: message,
                source: source,
                line: lineno,
                column: colno,
                error: error,
                stack: error ? error.stack : 'No stack trace'
            });
            
            addResult('‚ùå SCRIPT ERROR: ' + message + ' (Line: ' + lineno + ')', 'error');
            return false; // Don't suppress the error
        };
        
        // Unhandled promise rejection handler
        window.addEventListener('unhandledrejection', function(event) {
            console.error('üö® UNHANDLED PROMISE REJECTION:', event.reason);
            addResult('‚ùå PROMISE REJECTION: ' + event.reason, 'error');
        });
        
        function addResult(text, className = '') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.textContent = text;
            if (className) div.className = className;
            results.appendChild(div);
        }
        
        function displayBrowserInfo() {
            const info = {
                userAgent: navigator.userAgent,
                platform: navigator.platform,
                language: navigator.language,
                onLine: navigator.onLine,
                cookieEnabled: navigator.cookieEnabled,
                isFirefox: navigator.userAgent.toLowerCase().includes('firefox'),
                isIOS: /iPad|iPhone|iPod/.test(navigator.userAgent),
                isSafari: navigator.userAgent.toLowerCase().includes('safari') && !navigator.userAgent.toLowerCase().includes('chrome'),
                url: window.location.href,
                protocol: window.location.protocol,
                host: window.location.host
            };
            
            document.getElementById('browser-info').innerHTML = 
                '<pre>' + JSON.stringify(info, null, 2) + '</pre>';
        }
        
        function testBasicJS() {
            try {
                // Test arrow functions
                const test1 = () => 'arrow function';
                
                // Test destructuring
                const {a, b} = {a: 1, b: 2};
                
                // Test template literals
                const test2 = `template ${a + b}`;
                
                // Test const/let
                let testVar = 'let works';
                const testConst = 'const works';
                
                addResult('‚úÖ Basic JS features work', 'success');
            } catch (error) {
                addResult('‚ùå Basic JS failed: ' + error.message, 'error');
            }
        }
        
        function testPromises() {
            Promise.resolve('test')
                .then(result => {
                    addResult('‚úÖ Promises work: ' + result, 'success');
                })
                .catch(error => {
                    addResult('‚ùå Promise failed: ' + error.message, 'error');
                });
        }
        
        function testFetch() {
            // Test the exact endpoint that was failing
            const apiUrl = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' 
                ? 'http://localhost:8000' 
                : 'http://192.168.1.129:8000';
            
            fetch(apiUrl + '/api/v1/debug/health')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('HTTP ' + response.status + ': ' + response.statusText);
                    }
                    return response.json();
                })
                .then(data => {
                    addResult('‚úÖ Fetch API works: ' + JSON.stringify(data), 'success');
                })
                .catch(error => {
                    addResult('‚ùå Fetch failed: ' + error.message, 'error');
                });
        }
        
        function testLocalStorage() {
            try {
                localStorage.setItem('test', 'value');
                const value = localStorage.getItem('test');
                localStorage.removeItem('test');
                addResult('‚úÖ LocalStorage works: ' + value, 'success');
            } catch (error) {
                addResult('‚ùå LocalStorage failed: ' + error.message, 'error');
            }
        }
        
        function simulateScriptError() {
            try {
                // This should trigger a "Script error" type error
                nonExistentFunction();
            } catch (error) {
                addResult('‚úÖ Caught error properly: ' + error.message, 'success');
            }
        }
        
        // Initialize
        displayBrowserInfo();
        addResult('üîß Minimal test page loaded successfully', 'success');
    </script>
</body>
</html>
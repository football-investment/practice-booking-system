<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iPad/Safari Script Error Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .info {
            background: #cce7ff;
            color: #004085;
            border: 1px solid #b3d9ff;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        button:hover {
            background: #0056b3;
        }
        #console-output {
            background: #000;
            color: #00ff00;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            height: 300px;
            overflow-y: scroll;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <h1>üîß iPad/Safari Script Error Fix Test</h1>
    
    <div class="info">
        <h3>üîç Browser Information</h3>
        <div id="browser-info"></div>
    </div>

    <div class="test-result info">
        <h3>üìã Test Controls</h3>
        <button onclick="runAllTests()">üöÄ Run All Tests</button>
        <button onclick="simulateScriptError()">‚ö° Simulate Script Error</button>
        <button onclick="testDateParsing()">üìÖ Test Date Parsing</button>
        <button onclick="testCrossOrigin()">üåê Test Cross-Origin</button>
        <button onclick="clearResults()">üßπ Clear Results</button>
    </div>

    <div id="test-results"></div>

    <h3>üìä Console Output</h3>
    <div id="console-output"></div>

    <script>
        // Capture console output for display
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;
        const consoleOutput = document.getElementById('console-output');

        function addToConsole(type, message) {
            const timestamp = new Date().toISOString().substr(11, 12);
            const prefix = type === 'error' ? '‚ùå' : type === 'warn' ? '‚ö†Ô∏è' : '‚úÖ';
            consoleOutput.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        }

        console.log = function(...args) {
            originalLog.apply(console, args);
            addToConsole('log', args.join(' '));
        };

        console.error = function(...args) {
            originalError.apply(console, args);
            addToConsole('error', args.join(' '));
        };

        console.warn = function(...args) {
            originalWarn.apply(console, args);
            addToConsole('warn', args.join(' '));
        };

        // Browser detection
        function detectBrowser() {
            const userAgent = navigator.userAgent.toLowerCase();
            const isIOS = /ipad|iphone|ipod/.test(userAgent);
            const isSafari = userAgent.includes('safari') && !userAgent.includes('chrome');
            const isFirefox = userAgent.includes('firefox');
            
            document.getElementById('browser-info').innerHTML = `
                <p><strong>User Agent:</strong> ${navigator.userAgent}</p>
                <p><strong>Platform:</strong> ${navigator.platform}</p>
                <p><strong>Language:</strong> ${navigator.language}</p>
                <p><strong>iOS Device:</strong> ${isIOS ? '‚úÖ Yes' : '‚ùå No'}</p>
                <p><strong>Safari Browser:</strong> ${isSafari ? '‚úÖ Yes' : '‚ùå No'}</p>
                <p><strong>Firefox Browser:</strong> ${isFirefox ? '‚úÖ Yes' : '‚ùå No'}</p>
                <p><strong>Online:</strong> ${navigator.onLine ? '‚úÖ Yes' : '‚ùå No'}</p>
                <p><strong>Viewport:</strong> ${window.innerWidth} x ${window.innerHeight}</p>
            `;
        }

        // Test functions
        function addTestResult(title, success, message) {
            const resultsDiv = document.getElementById('test-results');
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-result ${success ? 'success' : 'error'}`;
            resultDiv.innerHTML = `<strong>${success ? '‚úÖ' : '‚ùå'} ${title}</strong><br>${message}`;
            resultsDiv.appendChild(resultDiv);
        }

        function simulateScriptError() {
            console.log('üß™ Simulating Script Error...');
            
            // This should trigger our custom error handler
            try {
                // Simulate cross-origin script error
                throw new Error('Script error.');
            } catch (error) {
                // Manually trigger the error handler
                if (window.onerror) {
                    const result = window.onerror('Script error.', '', 0, 0, error);
                    addTestResult('Script Error Simulation', 
                        result === true, 
                        result === true ? 'Custom error handler caught and handled the error' : 'Error was not properly handled');
                } else {
                    addTestResult('Script Error Simulation', false, 'No custom error handler found');
                }
            }
        }

        function testDateParsing() {
            console.log('üìÖ Testing Date Parsing...');
            
            const testDates = [
                '2025-09-15T10:00:00',
                '2025-09-15 10:00:00',
                'Sep 15 2025',
                '2025/09/15'
            ];

            let successCount = 0;
            const results = [];

            testDates.forEach(dateStr => {
                try {
                    const date = new Date(dateStr);
                    if (!isNaN(date.getTime())) {
                        successCount++;
                        results.push(`‚úÖ "${dateStr}" ‚Üí ${date.toString()}`);
                    } else {
                        results.push(`‚ùå "${dateStr}" ‚Üí Invalid date`);
                    }
                } catch (error) {
                    results.push(`‚ùå "${dateStr}" ‚Üí Error: ${error.message}`);
                }
            });

            addTestResult('Date Parsing Test', 
                successCount > 0, 
                `${successCount}/${testDates.length} dates parsed successfully:<br>${results.join('<br>')}`);
        }

        function testCrossOrigin() {
            console.log('üåê Testing Cross-Origin Requests...');
            
            const testUrls = [
                '/api/v1/debug/health',
                `${window.location.origin}/api/v1/debug/health`
            ];

            let completedTests = 0;
            const results = [];

            testUrls.forEach(url => {
                fetch(url, { method: 'HEAD' })
                    .then(response => {
                        completedTests++;
                        results.push(`‚úÖ ${url} ‚Üí Status: ${response.status}`);
                        
                        if (completedTests === testUrls.length) {
                            addTestResult('Cross-Origin Test', true, results.join('<br>'));
                        }
                    })
                    .catch(error => {
                        completedTests++;
                        results.push(`‚ùå ${url} ‚Üí Error: ${error.message}`);
                        
                        if (completedTests === testUrls.length) {
                            addTestResult('Cross-Origin Test', 
                                results.some(r => r.includes('‚úÖ')), 
                                results.join('<br>'));
                        }
                    });
            });
        }

        function testLocalStorage() {
            console.log('üíæ Testing Local Storage...');
            
            try {
                const testKey = '__ipad_test__';
                const testValue = 'test_value_' + Date.now();
                
                localStorage.setItem(testKey, testValue);
                const retrievedValue = localStorage.getItem(testKey);
                localStorage.removeItem(testKey);
                
                addTestResult('Local Storage Test', 
                    retrievedValue === testValue, 
                    retrievedValue === testValue ? 'Local storage works correctly' : 'Local storage failed');
            } catch (error) {
                addTestResult('Local Storage Test', false, `Error: ${error.message}`);
            }
        }

        function testErrorBoundary() {
            console.log('üõ°Ô∏è Testing Error Boundary...');
            
            // Check if React is available and has error boundaries
            if (typeof React !== 'undefined' && React.Component) {
                addTestResult('Error Boundary Test', true, 'React is available and supports error boundaries');
            } else {
                addTestResult('Error Boundary Test', false, 'React is not available or does not support error boundaries');
            }
        }

        function runAllTests() {
            console.log('üöÄ Running all iPad/Safari compatibility tests...');
            clearResults();
            
            setTimeout(simulateScriptError, 100);
            setTimeout(testDateParsing, 200);
            setTimeout(testCrossOrigin, 300);
            setTimeout(testLocalStorage, 400);
            setTimeout(testErrorBoundary, 500);
        }

        function clearResults() {
            document.getElementById('test-results').innerHTML = '';
            document.getElementById('console-output').textContent = '';
        }

        // Initialize
        detectBrowser();
        
        // Setup enhanced error handling like our main app
        window.onerror = function(message, source, lineno, colno, error) {
            console.log('üîß Enhanced error handler triggered:', {
                message: message,
                source: source,
                line: lineno,
                column: colno,
                error: error
            });

            // Safari-specific "Script error" handling
            if (message === 'Script error.' || message === 'Script error') {
                console.warn('üîß Safari Script Error detected - our fix is working!');
                return true; // Prevent default Safari error display
            }
            
            return false;
        };

        console.log('‚úÖ iPad/Safari Test Page Loaded Successfully');
        console.log('üîß Ready to test error handling fixes');
    </script>
</body>
</html>
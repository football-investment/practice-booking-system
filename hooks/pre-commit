#!/usr/bin/env bash
# =============================================================================
# pre-commit hook: Champion Badge Static Guard
# =============================================================================
#
# Fast static check (<1s) that catches the most obvious regression before
# any test infrastructure is spun up.
#
# What it checks:
#   If any staged Python file introduces a literal "No ranking data" string
#   in proximity to a CHAMPION condition, the commit is blocked.
#
# This is a first-line defence — the full E2E guard runs at pre-push.
#
# Skipping (emergency use only):
#   SKIP_CHAMPION_COMMIT_CHECK=1 git commit
# =============================================================================

set -uo pipefail

RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
BOLD='\033[1m'
NC='\033[0m'

# ── Emergency override ────────────────────────────────────────────────────────
if [[ "${SKIP_CHAMPION_COMMIT_CHECK:-0}" == "1" ]]; then
    echo -e "${YELLOW}⚠️   Champion commit check skipped (SKIP_CHAMPION_COMMIT_CHECK=1)${NC}"
    exit 0
fi

# ── Collect staged Python files ───────────────────────────────────────────────
STAGED_PY_FILES=$(git diff --cached --name-only --diff-filter=ACMR | grep '\.py$' || true)

if [[ -z "${STAGED_PY_FILES}" ]]; then
    exit 0
fi

# ── Check: literal "No ranking data" in staged Python diffs ──────────────────
FOUND_REGRESSION=0
OFFENDING_FILES=()

while IFS= read -r file; do
    [[ -n "${file}" ]] || continue
    # Check the STAGED content (index), not the working tree
    if git show ":${file}" 2>/dev/null | grep -q '"No ranking data"'; then
        FOUND_REGRESSION=1
        OFFENDING_FILES+=("${file}")
    fi
done <<< "${STAGED_PY_FILES}"

if [[ ${FOUND_REGRESSION} -eq 1 ]]; then
    echo ""
    echo -e "${RED}${BOLD}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "${RED}${BOLD}  ❌ CHAMPION commit guard FAILED — COMMIT BLOCKED${NC}"
    echo -e "${RED}${BOLD}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo ""
    echo -e "${RED}  Hardcoded string '\"No ranking data\"' detected in staged files:${NC}"
    for f in "${OFFENDING_FILES[@]}"; do
        echo "    • ${f}"
    done
    echo ""
    echo "  This string is the known regression marker."
    echo "  If this is a legitimate string (e.g. in a test fixture or comment),"
    echo "  review the usage carefully. The full E2E guard runs at pre-push."
    echo ""
    echo -e "${YELLOW}  If you are certain this is safe:${NC}"
    echo "    SKIP_CHAMPION_COMMIT_CHECK=1 git commit"
    echo ""
    exit 1
fi

# ── Check: performance_card.py staged without the CHAMPION guard ──────────────
PERF_CARD_FILE="streamlit_app/components/tournaments/performance_card.py"
if echo "${STAGED_PY_FILES}" | grep -qF "${PERF_CARD_FILE}"; then
    staged_content=$(git show ":${PERF_CARD_FILE}" 2>/dev/null || true)
    if ! echo "${staged_content}" | grep -q 'badge_type == "CHAMPION"'; then
        echo ""
        echo -e "${RED}${BOLD}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
        echo -e "${RED}${BOLD}  ❌ CHAMPION guard removed — COMMIT BLOCKED${NC}"
        echo -e "${RED}${BOLD}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
        echo ""
        echo -e "${RED}  ${PERF_CARD_FILE} is staged but${NC}"
        echo -e "${RED}  the CHAMPION guard (badge_type == \"CHAMPION\") is missing.${NC}"
        echo ""
        echo "  This guard prevents the CHAMPION badge from showing 'No ranking data'."
        echo "  Ensure the guard is present before committing this file."
        echo ""
        echo -e "${YELLOW}  If you are certain this removal is intentional:${NC}"
        echo "    SKIP_CHAMPION_COMMIT_CHECK=1 git commit"
        echo ""
        exit 1
    fi
fi

echo -e "   ${GREEN}✅  Champion commit guard passed${NC}"
exit 0

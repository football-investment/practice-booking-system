#!/usr/bin/env bash
# =============================================================================
# pre-push hook: Champion Badge Regression Guard  v2  (enterprise)
# =============================================================================
#
# BUSINESS RULE: CHAMPION badge must NEVER display "No ranking data"
#
# Lifecycle (fully self-contained):
#   1. Acquire lockfile  (prevents parallel hook runs)
#   2. Check FastAPI backend is reachable  (required, not managed here)
#   3. Start a dedicated Streamlit instance on TEST_PORT (default 8599)
#      â†’ isolates the test from any running dev instance on 8501
#   4. Wait for Streamlit readiness  (retry loop, START_TIMEOUT seconds)
#   5. Run the Playwright E2E regression test
#   6. Cleanup:  stop Streamlit + release lockfile  (trap EXIT/INT/TERM)
#
# Overriding  (emergency use only):
#   SKIP_CHAMPION_CHECK=1 SKIP_REASON="<explanation>" git push
#   â€¢ Both env vars are REQUIRED when skipping.
#   â€¢ Every skip is appended to .git/hooks/champion_skip_audit.log
#   â€¢ Skips without SKIP_REASON are BLOCKED.
#
# Tunable env vars:
#   CHAMPION_TEST_PORT      port for dedicated Streamlit (default: 8599)
#   CHAMPION_START_TIMEOUT  seconds to wait for readiness (default: 45)
#   CHAMPION_DB_URL         DATABASE_URL for the Streamlit process
#                           (defaults to lfa_intern_system connection string)
#   API_BASE_URL            FastAPI URL to health-check (default: http://localhost:8000)
#
# Installation:
#   ./hooks/install-hooks.sh
# =============================================================================

set -uo pipefail

# â”€â”€ Colours â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m'

err()  { echo -e "${RED}${BOLD}âŒ  $*${NC}" >&2; }
warn() { echo -e "${YELLOW}âš ï¸   $*${NC}" >&2; }
info() { echo -e "   $*"; }
ok()   { echo -e "   ${GREEN}âœ…  $*${NC}"; }

# â”€â”€ Config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
REPO_ROOT="$(git rev-parse --show-toplevel)"
TEST_PORT="${CHAMPION_TEST_PORT:-8599}"
START_TIMEOUT="${CHAMPION_START_TIMEOUT:-45}"
RETRY_INTERVAL=2
API_URL="${API_BASE_URL:-http://localhost:8000}"
DEFAULT_DB_URL="postgresql://postgres:postgres@localhost:5432/lfa_intern_system"
DB_URL="${CHAMPION_DB_URL:-${DEFAULT_DB_URL}}"

LOCKFILE="/tmp/champion_guard_${TEST_PORT}.lock"
AUDIT_LOG="${REPO_ROOT}/.git/hooks/champion_skip_audit.log"
TEST_FILE="${REPO_ROOT}/tests_e2e/test_champion_badge_regression.py"
VENV_ACTIVATE="${REPO_ROOT}/venv/bin/activate"
HOME_PY="${REPO_ROOT}/streamlit_app/ğŸ _Home.py"

STREAMLIT_PID=""

# â”€â”€ Cleanup trap â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
cleanup() {
    local exit_code=$?
    if [[ -n "${STREAMLIT_PID}" ]] && kill -0 "${STREAMLIT_PID}" 2>/dev/null; then
        kill "${STREAMLIT_PID}" 2>/dev/null || true
        # Brief wait so the port is released before the shell exits
        local waited=0
        while kill -0 "${STREAMLIT_PID}" 2>/dev/null && [[ ${waited} -lt 5 ]]; do
            sleep 1
            waited=$((waited + 1))
        done
    fi
    rm -f "${LOCKFILE}"
    exit "${exit_code}"
}
trap cleanup EXIT INT TERM

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 0.  SKIP override  (requires SKIP_REASON + writes audit log)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if [[ "${SKIP_CHAMPION_CHECK:-0}" == "1" ]]; then
    if [[ -z "${SKIP_REASON:-}" ]]; then
        err "SKIP_CHAMPION_CHECK=1 requires SKIP_REASON to be set."
        err "Example:  SKIP_CHAMPION_CHECK=1 SKIP_REASON=\"docs-only change\" git push"
        exit 1
    fi

    mkdir -p "$(dirname "${AUDIT_LOG}")"
    printf '%s  SKIP  branch=%s  user=%s  reason=%s\n' \
        "$(date -u '+%Y-%m-%dT%H:%M:%SZ')" \
        "$(git rev-parse --abbrev-ref HEAD 2>/dev/null || echo 'unknown')" \
        "$(git config user.email 2>/dev/null || echo 'unknown')" \
        "${SKIP_REASON}" \
        >> "${AUDIT_LOG}"

    echo ""
    warn "Champion guard SKIPPED â€” recorded in audit log"
    warn "Skip reason : ${SKIP_REASON}"
    warn "Audit log   : ${AUDIT_LOG}"
    echo ""
    exit 0
fi

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Banner
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
echo ""
echo -e "${CYAN}${BOLD}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${CYAN}${BOLD}  ğŸ† Champion Badge Regression Guard v2  (pre-push)${NC}"
echo -e "${CYAN}${BOLD}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 1.  Lockfile  (prevent parallel runs on the same port)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if [[ -f "${LOCKFILE}" ]]; then
    old_pid=$(cat "${LOCKFILE}" 2>/dev/null || echo "")
    if [[ -n "${old_pid}" ]] && kill -0 "${old_pid}" 2>/dev/null; then
        err "Another champion guard run is already in progress (PID ${old_pid})."
        err "If that is stale, delete: ${LOCKFILE}"
        exit 1
    else
        warn "Stale lockfile found â€” removing."
        rm -f "${LOCKFILE}"
    fi
fi
echo $$ > "${LOCKFILE}"

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 2.  Activate venv
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if [[ -f "${VENV_ACTIVATE}" ]]; then
    # shellcheck disable=SC1090
    source "${VENV_ACTIVATE}"
    ok "Virtual environment activated"
else
    warn "No venv found at ${VENV_ACTIVATE} â€” relying on system Python"
fi

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 3.  Check Playwright
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if ! python3 -c "import playwright" 2>/dev/null; then
    err "Playwright not found."
    info "Install: pip install playwright pytest-playwright && playwright install chromium"
    info ""
    info "Push blocked. Fix the installation or use:"
    info "  SKIP_CHAMPION_CHECK=1 SKIP_REASON=\"no playwright\" git push"
    exit 1
fi
ok "Playwright found"

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 4.  Check FastAPI backend (required â€” we do NOT manage it)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
info "Checking FastAPI backend at ${API_URL} ..."
if ! curl -sf "${API_URL}/docs" > /dev/null 2>&1 && \
   ! curl -sf "${API_URL}/health" > /dev/null 2>&1 && \
   ! curl -sf "${API_URL}/" > /dev/null 2>&1; then
    err "FastAPI backend not reachable at ${API_URL}"
    info ""
    info "Start the backend before pushing:"
    info "  DATABASE_URL=${DB_URL} \\"
    info "    uvicorn app.main:app --reload --host 0.0.0.0 --port 8000"
    info ""
    info "Push blocked. Start the backend or use:"
    info "  SKIP_CHAMPION_CHECK=1 SKIP_REASON=\"backend down\" git push"
    exit 1
fi
ok "FastAPI backend reachable"

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 5.  Start dedicated Streamlit on TEST_PORT  (background)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
info "Starting dedicated Streamlit on port ${TEST_PORT} ..."
STREAMLIT_LOG="/tmp/champion_streamlit_${TEST_PORT}.log"

DATABASE_URL="${DB_URL}" \
API_BASE_URL="${API_URL}" \
python3 -m streamlit run "${HOME_PY}" \
    --server.port "${TEST_PORT}" \
    --server.headless true \
    --server.address localhost \
    --browser.gatherUsageStats false \
    > "${STREAMLIT_LOG}" 2>&1 &
STREAMLIT_PID=$!

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 6.  Wait for Streamlit readiness  (retry loop)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ELAPSED=0
READY=0
while [[ ${ELAPSED} -lt ${START_TIMEOUT} ]]; do
    if curl -sf "http://localhost:${TEST_PORT}" > /dev/null 2>&1; then
        READY=1
        break
    fi
    # If the process died early, abort immediately
    if ! kill -0 "${STREAMLIT_PID}" 2>/dev/null; then
        err "Streamlit process exited unexpectedly."
        info "Log: ${STREAMLIT_LOG}"
        exit 1
    fi
    sleep "${RETRY_INTERVAL}"
    ELAPSED=$((ELAPSED + RETRY_INTERVAL))
    info "  Waiting for Streamlit... (${ELAPSED}/${START_TIMEOUT}s)"
done

if [[ ${READY} -eq 0 ]]; then
    err "Streamlit did not become ready within ${START_TIMEOUT}s."
    info "Log: ${STREAMLIT_LOG}"
    info ""
    info "Try increasing the timeout:"
    info "  CHAMPION_START_TIMEOUT=90 git push"
    info ""
    info "Or use emergency override:"
    info "  SKIP_CHAMPION_CHECK=1 SKIP_REASON=\"startup timeout\" git push"
    exit 1
fi
ok "Streamlit ready on http://localhost:${TEST_PORT}"

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 7.  Run the regression test
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
echo ""
info "Running regression test..."
echo ""

cd "${REPO_ROOT}"

export CHAMPION_TEST_URL="http://localhost:${TEST_PORT}"

if python3 -m pytest \
    "${TEST_FILE}::test_champion_badge_no_ranking_data_regression" \
    --tb=short \
    --no-header \
    -q \
    2>&1; then

    echo ""
    echo -e "${GREEN}${BOLD}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${GREEN}${BOLD}  âœ… CHAMPION guard PASSED â€” push allowed${NC}"
    echo -e "${GREEN}${BOLD}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
    exit 0

else
    echo ""
    echo -e "${RED}${BOLD}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${RED}${BOLD}  âŒ CHAMPION guard FAILED â€” PUSH BLOCKED${NC}"
    echo -e "${RED}${BOLD}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
    echo -e "${RED}  REGRESSION: CHAMPION badge shows 'No ranking data'${NC}"
    echo ""
    echo "  Debug steps:"
    echo "  1. Screenshot: tests_e2e/screenshots/champion_badge_FAILED.png"
    echo "  2. Streamlit log: ${STREAMLIT_LOG}"
    echo "  3. Verify CHAMPION guard is active in performance_card.py"
    echo "  4. Verify badge_metadata.placement is set in DB"
    echo ""
    echo -e "${YELLOW}  Emergency override (SKIP_REASON required):${NC}"
    echo "    SKIP_CHAMPION_CHECK=1 SKIP_REASON=\"<your reason>\" git push"
    echo ""
    exit 1
fi

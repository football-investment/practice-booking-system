#!/usr/bin/env bash
# =============================================================================
# pre-push hook: Champion Badge Regression Guard
# =============================================================================
#
# BUSINESS RULE: CHAMPION badge must NEVER display "No ranking data"
#
# This hook runs the golden-path E2E regression test before every push.
# If the test fails â†’ push is BLOCKED.
# If the test passes â†’ push proceeds.
#
# Skipping:
#   SKIP_CHAMPION_CHECK=1 git push   (emergency override â€” use with caution)
#
# Installation:
#   ./hooks/install-hooks.sh
#
# Requirements:
#   - Streamlit app running on http://localhost:8501
#   - venv/bin/activate present (or playwright accessible on PATH)
# =============================================================================

set -euo pipefail

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m'

# â”€â”€ Emergency override â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if [[ "${SKIP_CHAMPION_CHECK:-0}" == "1" ]]; then
    echo -e "${YELLOW}âš ï¸  CHAMPION check skipped (SKIP_CHAMPION_CHECK=1)${NC}"
    echo -e "${YELLOW}   This override is for emergencies only. Document the reason.${NC}"
    exit 0
fi

# â”€â”€ Locate project root (the repo root, wherever the hook is called from) â”€â”€â”€â”€
REPO_ROOT="$(git rev-parse --show-toplevel)"
TEST_FILE="tests_e2e/test_champion_badge_regression.py"
VENV_ACTIVATE="${REPO_ROOT}/venv/bin/activate"

echo ""
echo -e "${CYAN}${BOLD}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${CYAN}${BOLD}  ğŸ† Champion Badge Regression Guard (pre-push)${NC}"
echo -e "${CYAN}${BOLD}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"

# â”€â”€ Activate venv if available â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if [[ -f "${VENV_ACTIVATE}" ]]; then
    # shellcheck disable=SC1090
    source "${VENV_ACTIVATE}"
fi

# â”€â”€ Check Playwright is available â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if ! python3 -c "import playwright" 2>/dev/null; then
    echo -e "${RED}âŒ Playwright not found.${NC}"
    echo "   Install: pip install playwright pytest-playwright && playwright install chromium"
    echo ""
    echo -e "${YELLOW}Push blocked. Fix Playwright installation or use:${NC}"
    echo "   SKIP_CHAMPION_CHECK=1 git push"
    exit 1
fi

# â”€â”€ Check Streamlit is running â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if ! curl -sf http://localhost:8501 > /dev/null 2>&1; then
    echo -e "${RED}âŒ Streamlit is not running on http://localhost:8501${NC}"
    echo ""
    echo "   Start it first:"
    echo "   DATABASE_URL=postgresql://postgres:postgres@localhost:5432/lfa_intern_system \\"
    echo "     streamlit run streamlit_app/ğŸ _Home.py --server.port 8501"
    echo ""
    echo -e "${YELLOW}Push blocked. Start Streamlit or use:${NC}"
    echo "   SKIP_CHAMPION_CHECK=1 git push"
    exit 1
fi

echo -e "   âœ… Streamlit is running"
echo -e "   ğŸ§ª Running regression test..."
echo ""

# â”€â”€ Run the test â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
cd "${REPO_ROOT}"

if python3 -m pytest "${TEST_FILE}::test_champion_badge_no_ranking_data_regression" \
    --tb=short \
    --no-header \
    -q \
    2>&1; then

    echo ""
    echo -e "${GREEN}${BOLD}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${GREEN}${BOLD}  âœ… CHAMPION guard PASSED â€” push allowed${NC}"
    echo -e "${GREEN}${BOLD}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
    exit 0

else
    echo ""
    echo -e "${RED}${BOLD}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${RED}${BOLD}  âŒ CHAMPION guard FAILED â€” PUSH BLOCKED${NC}"
    echo -e "${RED}${BOLD}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
    echo -e "${RED}  REGRESSION DETECTED: CHAMPION badge shows 'No ranking data'${NC}"
    echo ""
    echo "  Debug steps:"
    echo "  1. Check screenshot: tests_e2e/screenshots/champion_badge_FAILED.png"
    echo "  2. Verify performance_card.py CHAMPION guard is active"
    echo "  3. Verify badge_metadata.placement is populated in DB"
    echo ""
    echo -e "${YELLOW}  Emergency override (document your reason):${NC}"
    echo "     SKIP_CHAMPION_CHECK=1 git push"
    echo ""
    exit 1
fi

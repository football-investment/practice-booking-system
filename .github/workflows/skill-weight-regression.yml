name: Skill Weight Pipeline — Regression Gate

# ─── Trigger ────────────────────────────────────────────────────────────────
# Required check: blocks PR merge to main/develop if any of the 28+ tests fail.
# Also runs on push to main so the baseline is verified after every merge.
on:
  pull_request:
    branches: [ main, develop, feature/* ]
    paths:
      # Run when pipeline code or tests change
      - 'app/services/skill_progression_service.py'
      - 'app/services/tournament/tournament_participation_service.py'
      - 'app/services/tournament/tournament_reward_orchestrator.py'
      - 'app/api/api_v1/endpoints/tournaments/create.py'
      - 'tests/unit/tournament/test_skill_weight_pipeline.py'
      # Always run when workflow itself changes
      - '.github/workflows/skill-weight-regression.yml'
  push:
    branches: [ main, develop ]

# ─── Jobs ───────────────────────────────────────────────────────────────────
jobs:
  skill-weight-regression:
    name: "Skill Weight Pipeline — 28 required tests"
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: lfa_intern_system_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-mock

      - name: Run Alembic migrations on test DB
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/lfa_intern_system_test
          SECRET_KEY: ci-test-secret-key-not-for-production
        run: |
          alembic upgrade head

      # ── Stage 1: Pure-math tests (no DB, must be instant) ─────────────────
      - name: "Stage 1 — Pure-math tests (reactivity + EMA, no DB)"
        run: |
          pytest tests/unit/tournament/test_skill_weight_pipeline.py \
            -k "TestReactivityConversion or TestEMAStepMath" \
            -v --tb=short \
            --no-header
        # No DATABASE_URL needed — these are pure Python

      # ── Stage 2: DB-backed tests (postgres_db fixture) ────────────────────
      - name: "Stage 2 — DB-backed tests (skill_points + full delta pipeline)"
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/lfa_intern_system_test
        run: |
          pytest tests/unit/tournament/test_skill_weight_pipeline.py \
            -k "TestSkillPointsDistribution or TestSkillDeltaPipeline" \
            -v --tb=short \
            --no-header

      # ── Stage 3: Full suite including multi-seed + edge cases ─────────────
      - name: "Stage 3 — Full pipeline suite (all 28+ tests)"
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/lfa_intern_system_test
        run: |
          pytest tests/unit/tournament/test_skill_weight_pipeline.py \
            -v --tb=short \
            --no-header \
            --junit-xml=test-results/skill-weight-pipeline.xml

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: skill-weight-test-results
          path: test-results/skill-weight-pipeline.xml
          retention-days: 30

      - name: Summary
        if: always()
        run: |
          echo "## Skill Weight Pipeline — Regression Gate" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Tests | Result |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Pure math (no DB) | TestReactivityConversion + TestEMAStepMath | 17 tests |" >> $GITHUB_STEP_SUMMARY
          echo "| DB-backed (postgres_db) | TestSkillPointsDistribution + TestSkillDeltaPipeline | 11 tests |" >> $GITHUB_STEP_SUMMARY
          echo "| Multi-seed variation | TestMultiSeedVariation | parametrized |" >> $GITHUB_STEP_SUMMARY
          echo "| Edge cases | TestEdgeCaseExtremeWeights + TestEdgeCaseClampBoundary + TestLargeTournament | stress |" >> $GITHUB_STEP_SUMMARY

  # ── Production safety audit (does not block merge, only reports) ──────────
  preset-weight-audit:
    name: "Preset Weight Audit (informational)"
    runs-on: ubuntu-latest
    needs: skill-weight-regression
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: lfa_intern_system_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run Alembic migrations on test DB
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/lfa_intern_system_test
          SECRET_KEY: ci-test-secret-key-not-for-production
        run: |
          alembic upgrade head

      - name: Run preset weight audit
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/lfa_intern_system_test
        run: |
          python scripts/maintenance/audit_preset_weights.py \
            --db-url postgresql://postgres:postgres@localhost:5432/lfa_intern_system_test \
            2>&1 | tee audit-output.txt

      - name: Upload audit report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: preset-weight-audit
          path: audit-output.txt
          retention-days: 90

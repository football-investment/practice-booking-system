name: E2E Integration Critical Suite (Nightly)

on:
  schedule:
    # Daily at 2 AM UTC (NON-BLOCKING, nightly run)
    - cron: '0 2 * * *'
  workflow_dispatch:  # Manual trigger
  pull_request:
    branches: [main, develop]
    paths:
      - 'tests_e2e/integration_critical/**'
      - '.github/workflows/e2e-integration-critical.yml'

jobs:
  integration-critical-suite:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:14
        env:
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: test_db
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest-xdist  # Parallel testing support

      - name: Run database migrations
        env:
          DATABASE_URL: postgresql://test_user:test_password@localhost:5432/test_db
        run: |
          alembic upgrade head

          # Verify migration state
          alembic current -v

      - name: Start FastAPI backend
        env:
          DATABASE_URL: postgresql://test_user:test_password@localhost:5432/test_db
        run: |
          uvicorn app.main:app --host 0.0.0.0 --port 8000 &
          sleep 5

          # Health check
          curl --fail http://localhost:8000/health || exit 1

      - name: Start Streamlit frontend
        run: |
          streamlit run streamlit_app/üè†_Home.py --server.port 8501 --server.headless true &
          sleep 10

          # Health check
          curl --fail http://localhost:8501 || exit 1

      - name: Run Integration Critical Suite (Sequential)
        run: |
          PYTHONPATH=. pytest tests_e2e/integration_critical/ \
            -v \
            --tb=short \
            -ra \
            --durations=5

      - name: Run Integration Critical Suite (Parallel - HARD REQUIREMENT)
        run: |
          PYTHONPATH=. pytest tests_e2e/integration_critical/ \
            -n auto \
            -v \
            --tb=short \
            -ra \
            --durations=5

      - name: Upload failure screenshots
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: integration-critical-screenshots
          path: tests_e2e/screenshots/*_FAILED.png
          retention-days: 7

      - name: Report test results
        if: always()
        run: |
          echo "Integration Critical Suite completed."
          echo "Note: Failures do NOT block PR merge (NON-BLOCKING policy)."
          echo "Review nightly summary for regression signals."

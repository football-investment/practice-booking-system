name: ğŸŒ Cross-Platform Testing Suite
on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  # Backend API Tests
  backend-tests:
    name: ğŸ”§ Backend API Testing
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:14
        env:
          POSTGRES_USER: testuser
          POSTGRES_PASSWORD: testpass
          POSTGRES_DB: test_practice_booking
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: ğŸ“¦ Install Dependencies  
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: ğŸ—ƒï¸ Setup Test Database
        run: |
          export DATABASE_URL="postgresql://testuser:testpass@localhost:5432/test_practice_booking"
          export TESTING=true
          python scripts/fresh_database_reset.py
          python scripts/comprehensive_test_seed.py

      - name: ğŸ§ª Run Backend Tests
        run: |
          export DATABASE_URL="postgresql://testuser:testpass@localhost:5432/test_practice_booking"
          export TESTING=true
          pytest app/tests/ -v --tb=short

      - name: ğŸš€ Start Backend Server
        run: |
          export DATABASE_URL="postgresql://testuser:testpass@localhost:5432/test_practice_booking"
          export SECRET_KEY="ci-test-secret-key-not-for-production"
          uvicorn app.main:app --host 0.0.0.0 --port 8000 &
          sleep 10
          curl http://localhost:8000/health

  # Frontend Build & Unit Tests
  frontend-tests:
    name: ğŸ¨ Frontend Build & Unit Tests
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: ğŸ“‚ Install Frontend Dependencies
        run: |
          cd frontend
          npm install

      - name: ğŸ§ª Run Frontend Tests
        run: |
          cd frontend
          npm test -- --coverage --watchAll=false

      - name: ğŸ—ï¸ Build Frontend
        run: |
          cd frontend
          CI=false npm run build

      - name: ğŸ“¤ Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: frontend/build

  # Cross-Browser E2E Testing
  cross-browser-testing:
    name: ğŸŒ Cross-Browser E2E Testing
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests]
    if: always()
    
    services:
      postgres:
        image: postgres:14
        env:
          POSTGRES_USER: testuser
          POSTGRES_PASSWORD: testpass
          POSTGRES_DB: test_practice_booking
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    
    strategy:
      fail-fast: false  # Allow all browsers to run even if one fails
      matrix:
        browser: [chromium, firefox, webkit]
        include:
          - browser: chromium
            browserstack_browser: "Chrome"
            browserstack_version: "latest"
          - browser: firefox
            browserstack_browser: "Firefox" 
            browserstack_version: "latest"
          - browser: webkit
            browserstack_browser: "Safari"
            browserstack_version: "latest"

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: ğŸ“¦ Install Backend Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: ğŸ—ƒï¸ Setup Test Database
        run: |
          export DATABASE_URL="postgresql://testuser:testpass@localhost:5432/test_practice_booking"
          export TESTING=true
          python scripts/fresh_database_reset.py
          python scripts/comprehensive_test_seed.py

      - name: ğŸ“¥ Download Frontend Build
        uses: actions/download-artifact@v4
        with:
          name: frontend-build
          path: frontend/build

      - name: ğŸ”§ Install E2E Dependencies
        run: |
          cd e2e-tests
          npm install
          npx playwright install --with-deps
          cd ..

      - name: ğŸš€ Start Test Environment
        run: |
          # Start backend with test database
          DATABASE_URL="postgresql://testuser:testpass@localhost:5432/test_practice_booking" SECRET_KEY="ci-test-secret-key-not-for-production" TESTING=true uvicorn app.main:app --host 0.0.0.0 --port 8000 &
          
          # Serve frontend build
          cd frontend
          npx serve -s build -l 3000 &
          
          # Wait for services to be ready
          sleep 15
          echo "Testing backend health..."
          curl -f http://localhost:8000/health || exit 1
          echo "Testing frontend availability..."
          curl -f http://localhost:3000 || exit 1

      - name: ğŸ§ª Run Playwright E2E Tests
        run: |
          cd e2e-tests
          npx playwright test --project="${{ matrix.browser }}" --reporter=html
          cd ..
        env:
          TEST_URL: http://localhost:3000
          API_URL: http://localhost:8000

      - name: ğŸ“¤ Upload E2E Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: e2e-results-${{ matrix.browser }}
          path: e2e-tests/playwright-report/

  # iOS Safari Testing (BrowserStack)
  ios-safari-testing:
    name: ğŸ“± iOS Safari Testing
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests]
    if: always()
    
    services:
      postgres:
        image: postgres:14
        env:
          POSTGRES_USER: testuser
          POSTGRES_PASSWORD: testpass
          POSTGRES_DB: test_practice_booking
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    
    strategy:
      matrix:
        device: 
          - { device: "iPhone 14", os_version: "16" }
          - { device: "iPad Pro 12.9 2022", os_version: "16" }
          - { device: "iPhone 13", os_version: "15" }

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js  
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: ğŸ”§ Install BrowserStack Dependencies
        run: |
          npm install webdriverio
          # Download BrowserStack Local binary directly
          wget -q https://www.browserstack.com/browserstack-local/BrowserStackLocal-linux-x64.zip
          unzip BrowserStackLocal-linux-x64.zip
          chmod +x BrowserStackLocal

      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: ğŸ“¦ Install Backend Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: ğŸ—ƒï¸ Setup Test Database
        run: |
          export DATABASE_URL="postgresql://testuser:testpass@localhost:5432/test_practice_booking"
          export TESTING=true
          python scripts/fresh_database_reset.py
          python scripts/comprehensive_test_seed.py

      - name: ğŸ“¥ Download Frontend Build
        uses: actions/download-artifact@v4
        with:
          name: frontend-build
          path: frontend/build

      - name: ğŸš€ Start Test Environment
        run: |
          # Start backend with test database
          DATABASE_URL="postgresql://testuser:testpass@localhost:5432/test_practice_booking" SECRET_KEY="ci-test-secret-key-not-for-production" TESTING=true uvicorn app.main:app --host 0.0.0.0 --port 8000 &
          
          # Serve frontend build
          cd frontend
          npx serve -s build -l 3000 &
          
          # Wait for services to be ready
          sleep 15
          echo "Testing backend health..."
          curl -f http://localhost:8000/health || exit 1
          echo "Testing frontend availability..."
          curl -f http://localhost:3000 || exit 1

      - name: ğŸš€ Start BrowserStack Local Tunnel
        run: |
          ./BrowserStackLocal --key ${{ secrets.BROWSERSTACK_ACCESS_KEY }} --local-identifier github-actions-${{ github.run_id }} --daemon start
          sleep 15
        env:
          BROWSERSTACK_USERNAME: ${{ secrets.BROWSERSTACK_USERNAME }}
          BROWSERSTACK_ACCESS_KEY: ${{ secrets.BROWSERSTACK_ACCESS_KEY }}

      - name: ğŸ§ª Run iOS Safari Tests
        run: |
          node e2e-tests/ios-safari-tests.js
        env:
          BROWSERSTACK_USERNAME: ${{ secrets.BROWSERSTACK_USERNAME }}
          BROWSERSTACK_ACCESS_KEY: ${{ secrets.BROWSERSTACK_ACCESS_KEY }}
          BROWSERSTACK_LOCAL_IDENTIFIER: github-actions-${{ github.run_id }}
          GITHUB_RUN_ID: ${{ github.run_id }}
          DEVICE: ${{ matrix.device.device }}
          OS_VERSION: ${{ matrix.device.os_version }}

  # Performance Testing
  performance-testing:
    name: âš¡ Performance Testing
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests]
    if: always() && needs.backend-tests.result == 'success' && needs.frontend-tests.result == 'success'
    
    services:
      postgres:
        image: postgres:14
        env:
          POSTGRES_USER: testuser
          POSTGRES_PASSWORD: testpass
          POSTGRES_DB: test_practice_booking
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: ğŸ“¦ Install Backend Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: ğŸ—ƒï¸ Setup Test Database
        run: |
          export DATABASE_URL="postgresql://testuser:testpass@localhost:5432/test_practice_booking"
          export TESTING=true
          python scripts/fresh_database_reset.py
          python scripts/comprehensive_test_seed.py

      - name: ğŸ”§ Setup Lighthouse CI
        run: |
          npm install -g @lhci/cli@0.12.x

      - name: ğŸ“¥ Download Frontend Build
        uses: actions/download-artifact@v4
        with:
          name: frontend-build
          path: frontend/build

      - name: ğŸš€ Start Test Environment
        run: |
          # Start both backend and frontend
          DATABASE_URL="postgresql://testuser:testpass@localhost:5432/test_practice_booking" SECRET_KEY="ci-test-secret-key-not-for-production" TESTING=true uvicorn app.main:app --host 0.0.0.0 --port 8000 &
          cd frontend && npx serve -s build -l 3000 &
          sleep 15

      - name: ğŸƒâ€â™‚ï¸ Run Lighthouse CI
        run: |
          lhci autorun --config=./lighthouserc.js
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}

  # Security Testing
  security-scanning:
    name: ğŸ”’ Security Scanning
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ›¡ï¸ Run CodeQL Analysis
        uses: github/codeql-action/init@v3
        with:
          languages: python, javascript

      - name: ğŸ” Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3

      - name: ğŸ” Run OWASP Dependency Check
        run: |
          # Python dependencies (informational only)
          pip install safety
          safety check || echo "âš ï¸ Python vulnerabilities found (informational)"
          
          # Node.js dependencies (informational only)
          cd frontend
          npm audit --audit-level high || echo "âš ï¸ Node.js vulnerabilities found (informational)"

  # Test Results Summary
  test-summary:
    name: ğŸ“Š Test Results Summary
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests, cross-browser-testing, ios-safari-testing, performance-testing, security-scanning]
    if: always()
    
    steps:
      - name: ğŸ“¥ Download All Artifacts
        uses: actions/download-artifact@v4

      - name: ğŸ“Š Generate Test Report
        run: |
          echo "# ğŸ§ª Cross-Platform Test Results" > test-summary.md
          echo "" >> test-summary.md
          echo "## Core Pipeline Status" >> test-summary.md
          echo "- ğŸ”§ Backend API Testing: âœ… ${{ needs.backend-tests.result }}" >> test-summary.md
          echo "- ğŸ¨ Frontend Build & Tests: âœ… ${{ needs.frontend-tests.result }}" >> test-summary.md
          echo "- ğŸ”’ Security Scanning: âœ… ${{ needs.security-scanning.result }}" >> test-summary.md
          echo "" >> test-summary.md
          echo "## Cross-Platform Testing" >> test-summary.md
          echo "- ğŸŒ E2E Testing (Chromium/Firefox/WebKit): ${{ needs.cross-browser-testing.result }}" >> test-summary.md
          echo "- ğŸ“± iOS Safari Testing: ${{ needs.ios-safari-testing.result }}" >> test-summary.md
          echo "- âš¡ Performance Testing (Lighthouse): ${{ needs.performance-testing.result }}" >> test-summary.md
          echo "" >> test-summary.md
          echo "## Summary" >> test-summary.md
          echo "Generated: $(date)" >> test-summary.md
          echo "Pipeline Run: ${{ github.run_id }}" >> test-summary.md

      - name: ğŸ“¤ Upload Test Summary
        uses: actions/upload-artifact@v4
        with:
          name: test-summary
          path: test-summary.md